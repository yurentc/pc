<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>网址导航</title>
    <style>
        table, th, td {
            padding: 1px;
        }
    </style>
</head>
<body>
{% set urls_by_category = get_urls_by_category %}

<h1>网址导航</h1>

<h2>分类管理</h2>
<form action="/link/add_category" method="POST">
    <input type="text" name="name" placeholder="分类名称" required>
    <button type="submit">添加分类</button>
</form>

<ul>
    {% for category in categories %}

<li data-category-id="{{ category['id'] }}">
  <span class="category-name">{{ category['name'] }}</span>
  <a href="/link" class="edit-link" onclick="editCategory(event, {{ category['id'] }})">&#9998;</a>
  <a href="/link/delete_category/{{ category['id'] }}" onclick="event.preventDefault(); deleteCategory(event, {{ category['id'] }})">❌</a>
    <a> </a>
</li>

    <li>
        <table>
            <tr>
                <th>网站名</th>
                <th>链接</th>
                <th>点击量</th>
                <th colspan="2">操作</th>
            </tr>

            {% for url in urls_by_category(category['id'])|sort(attribute='click_count', reverse=True) %}
            <tr>
                <td>{{ url['title'] }}</td>
           <td><a href="{{ url['url'] }}" target="_blank" onclick="incrementClickCount(event, '{{ url['url'] }}', {{ url['id'] }})">{{ url['url'] }}</a></td>
    <td class="click-count">{{ url['click_count'] }}</td>

<td>
 <a href="javascript:void(0)" onclick="editUrl({{ url.id }}, '{{ url.title }}', '{{ url.url }}')">✎</a>
    <a href="/link/delete_url/{{ url['id'] }}" onclick="deleteURL(event, {{ url['id'] }})">❌</a>
</td>


            </tr>
            {% endfor %}

            <tr>
                <td colspan="5">
                    <form action="/link/add_url" method="POST">
                        <input type="hidden" name="category_id" value="{{ category['id'] }}">
                        <input type="text" name="title" placeholder="网站名" required>
                        <input type="url" name="url" placeholder="链接" required>
                        <button type="submit">+</button>
                    </form>
                </td>
            </tr>
        </table>
    </li>
    {% endfor %}
</ul>

<script>
    // 删除分类
    function deleteCategory(event, categoryId) {
        event.preventDefault();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/link/delete_category/' + categoryId;
            document.body.appendChild(form);
            form.submit();
    }

    // 删除网址
    function deleteURL(event, urlId) {
        event.preventDefault();


            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/link/delete_url/' + urlId;

            document.body.appendChild(form);
            form.submit();

    }
        // 增加点击量
    // 增加点击量
function incrementClickCount(event, url, urlId) {
            event.preventDefault();

        // Send an AJAX request to increment the click count
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/link/increase_click_count/' + urlId);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // Increment the click count in the UI
                    const clickCountElements = document.getElementsByClassName('click-count');
                    for (let i = 0; i < clickCountElements.length; i++) {
                        if (clickCountElements[i].dataset.urlId == urlId) {
                            clickCountElements[i].textContent = parseInt(clickCountElements[i].textContent) + 1;
                            break;
                        }
                    }

                    // Open the link in a new window
                    window.open(url, '_blank');
                } else {
                    console.error('Failed to increment click count.');
                }
            }
        };
        xhr.send(JSON.stringify({})); // Send an empty payload
    }

// JavaScript 代码
function editCategory(event, categoryId) {
  event.preventDefault();

  // 获取要编辑的分类元素以及分类名称元素
  const categoryElement = event.target.parentNode;
  const categoryNameElement = categoryElement.querySelector('.category-name');


  // 隐藏分类名称和编辑按钮元素
  categoryNameElement.style.display = 'none';
  event.target.style.display = 'none';

  // 创建一个输入框元素
  const inputElement = document.createElement('input');
  inputElement.type = 'text';
  inputElement.name = 'name';
  inputElement.value = categoryNameElement.textContent.trim();
  inputElement.required = true;

  // 创建一个保存按钮元素
  const saveButtonElement = document.createElement('button');
  saveButtonElement.type = 'button';
  saveButtonElement.textContent = '💾';

  // 将输入框和保存按钮添加到分类元素中
  categoryElement.appendChild(inputElement);
  categoryElement.appendChild(saveButtonElement);

  saveButtonElement.addEventListener('click', () => {
    // 获取输入框中的新类别名称
    const newCategoryName = inputElement.value.trim();

    if (newCategoryName !== '') {
      // 发送PUT请求，将新的类别名称更新到服务器端
      fetch(`/link/edit_category/${categoryId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: newCategoryName
        })
      })
      .then(response => response.json())
      .then(data => {
        // 更新页面上的类别名称
        categoryNameElement.textContent = data.name;
        categoryNameElement.style.display = 'inline';
        event.target.style.display = 'inline';

        // 移除输入框和保存按钮
        categoryElement.removeChild(inputElement);
        categoryElement.removeChild(saveButtonElement);
      })
      .catch(error => {
        console.error(error);
        alert('编辑分类失败，请重试！');
      });
    }
  });
}


function editUrl(urlId, urlTitle, urlUrl) {
  const titleInputElement = document.querySelector('input[name="title"]');
  const urlInputElement = document.querySelector('input[name="url"]');

  titleInputElement.value = urlTitle;
  urlInputElement.value = urlUrl;

  // 调用 deleteURL 函数
 // deleteURL(event, urlId);
}

</script>


</body>
</html>

