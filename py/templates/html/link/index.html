<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>ç½‘å€å¯¼èˆª</title>
    <style>
        table, th, td {
            padding: 1px;
        }
    </style>
</head>
<body>
{% set urls_by_category = get_urls_by_category %}

<h1>ç½‘å€å¯¼èˆª</h1>

<h2>åˆ†ç±»ç®¡ç†</h2>
<form action="/link/add_category" method="POST">
    <input type="text" name="name" placeholder="åˆ†ç±»åç§°" required>
    <button type="submit">æ·»åŠ åˆ†ç±»</button>
</form>

<ul>
    {% for category in categories %}

<li data-category-id="{{ category['id'] }}">
  <span class="category-name">{{ category['name'] }}</span>
  <a href="/link" class="edit-link" onclick="editCategory(event, {{ category['id'] }})">&#9998;</a>
  <a href="/link/delete_category/{{ category['id'] }}" onclick="event.preventDefault(); deleteCategory(event, {{ category['id'] }})">âŒ</a>
    <a> </a>
</li>

    <li>
        <table>
            <tr>
                <th>ç½‘ç«™å</th>
                <th>é“¾æ¥</th>
                <th>ç‚¹å‡»é‡</th>
                <th colspan="2">æ“ä½œ</th>
            </tr>

            {% for url in urls_by_category(category['id'])|sort(attribute='click_count', reverse=True) %}
            <tr>
                <td>{{ url['title'] }}</td>
           <td><a href="{{ url['url'] }}" target="_blank" onclick="incrementClickCount(event, '{{ url['url'] }}', {{ url['id'] }})">{{ url['url'] }}</a></td>
    <td class="click-count">{{ url['click_count'] }}</td>

<td>
 <a href="javascript:void(0)" onclick="editUrl({{ url.id }}, '{{ url.title }}', '{{ url.url }}')">âœ</a>
    <a href="/link/delete_url/{{ url['id'] }}" onclick="deleteURL(event, {{ url['id'] }})">âŒ</a>
</td>


            </tr>
            {% endfor %}

            <tr>
                <td colspan="5">
                    <form action="/link/add_url" method="POST">
                        <input type="hidden" name="category_id" value="{{ category['id'] }}">
                        <input type="text" name="title" placeholder="ç½‘ç«™å" required>
                        <input type="url" name="url" placeholder="é“¾æ¥" required>
                        <button type="submit">+</button>
                    </form>
                </td>
            </tr>
        </table>
    </li>
    {% endfor %}
</ul>

<script>
    // åˆ é™¤åˆ†ç±»
    function deleteCategory(event, categoryId) {
        event.preventDefault();
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/link/delete_category/' + categoryId;
            document.body.appendChild(form);
            form.submit();
    }

    // åˆ é™¤ç½‘å€
    function deleteURL(event, urlId) {
        event.preventDefault();


            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/link/delete_url/' + urlId;

            document.body.appendChild(form);
            form.submit();

    }
        // å¢åŠ ç‚¹å‡»é‡
    // å¢åŠ ç‚¹å‡»é‡
function incrementClickCount(event, url, urlId) {
            event.preventDefault();

        // Send an AJAX request to increment the click count
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/link/increase_click_count/' + urlId);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    // Increment the click count in the UI
                    const clickCountElements = document.getElementsByClassName('click-count');
                    for (let i = 0; i < clickCountElements.length; i++) {
                        if (clickCountElements[i].dataset.urlId == urlId) {
                            clickCountElements[i].textContent = parseInt(clickCountElements[i].textContent) + 1;
                            break;
                        }
                    }

                    // Open the link in a new window
                    window.open(url, '_blank');
                } else {
                    console.error('Failed to increment click count.');
                }
            }
        };
        xhr.send(JSON.stringify({})); // Send an empty payload
    }

// JavaScript ä»£ç 
function editCategory(event, categoryId) {
  event.preventDefault();

  // è·å–è¦ç¼–è¾‘çš„åˆ†ç±»å…ƒç´ ä»¥åŠåˆ†ç±»åç§°å…ƒç´ 
  const categoryElement = event.target.parentNode;
  const categoryNameElement = categoryElement.querySelector('.category-name');


  // éšè—åˆ†ç±»åç§°å’Œç¼–è¾‘æŒ‰é’®å…ƒç´ 
  categoryNameElement.style.display = 'none';
  event.target.style.display = 'none';

  // åˆ›å»ºä¸€ä¸ªè¾“å…¥æ¡†å…ƒç´ 
  const inputElement = document.createElement('input');
  inputElement.type = 'text';
  inputElement.name = 'name';
  inputElement.value = categoryNameElement.textContent.trim();
  inputElement.required = true;

  // åˆ›å»ºä¸€ä¸ªä¿å­˜æŒ‰é’®å…ƒç´ 
  const saveButtonElement = document.createElement('button');
  saveButtonElement.type = 'button';
  saveButtonElement.textContent = 'ğŸ’¾';

  // å°†è¾“å…¥æ¡†å’Œä¿å­˜æŒ‰é’®æ·»åŠ åˆ°åˆ†ç±»å…ƒç´ ä¸­
  categoryElement.appendChild(inputElement);
  categoryElement.appendChild(saveButtonElement);

  saveButtonElement.addEventListener('click', () => {
    // è·å–è¾“å…¥æ¡†ä¸­çš„æ–°ç±»åˆ«åç§°
    const newCategoryName = inputElement.value.trim();

    if (newCategoryName !== '') {
      // å‘é€PUTè¯·æ±‚ï¼Œå°†æ–°çš„ç±»åˆ«åç§°æ›´æ–°åˆ°æœåŠ¡å™¨ç«¯
      fetch(`/link/edit_category/${categoryId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: newCategoryName
        })
      })
      .then(response => response.json())
      .then(data => {
        // æ›´æ–°é¡µé¢ä¸Šçš„ç±»åˆ«åç§°
        categoryNameElement.textContent = data.name;
        categoryNameElement.style.display = 'inline';
        event.target.style.display = 'inline';

        // ç§»é™¤è¾“å…¥æ¡†å’Œä¿å­˜æŒ‰é’®
        categoryElement.removeChild(inputElement);
        categoryElement.removeChild(saveButtonElement);
      })
      .catch(error => {
        console.error(error);
        alert('ç¼–è¾‘åˆ†ç±»å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      });
    }
  });
}


function editUrl(urlId, urlTitle, urlUrl) {
  const titleInputElement = document.querySelector('input[name="title"]');
  const urlInputElement = document.querySelector('input[name="url"]');

  titleInputElement.value = urlTitle;
  urlInputElement.value = urlUrl;

  // è°ƒç”¨ deleteURL å‡½æ•°
 // deleteURL(event, urlId);
}

</script>


</body>
</html>

